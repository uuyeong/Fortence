import google.generativeai as genai
from config import GEMINI_API_KEY
from datetime import datetime
import json
from saju_calculator import SajuCalculator

class FortuneAnalyzer:
    def __init__(self):
        if not GEMINI_API_KEY:
            raise ValueError("GEMINI_API_KEY가 설정되지 않았습니다.")
        
        genai.configure(api_key=GEMINI_API_KEY)
        self.model = genai.GenerativeModel('gemini-1.5-flash')
        self.saju_calculator = SajuCalculator()
    
    
    def analyze_fortune(self, name, birth_date, birth_time, message="", profile_data=None, user_id=None, rag_context=""):
        """
        생년월일시와 사용자 프로필, RAG 컨텍스트를 기반으로 사주를 분석합니다.
        """
        try:
            # 생년월일시를 한국어로 변환 (시간 형식 처리)
            # birth_time이 "HH:MM:SS" 또는 "HH:MM" 형식일 수 있음
            if len(birth_time.split(':')) == 3:
                # "HH:MM:SS" 형식
                birth_datetime = datetime.strptime(f"{birth_date} {birth_time}", "%Y-%m-%d %H:%M:%S")
            else:
                # "HH:MM" 형식
                birth_datetime = datetime.strptime(f"{birth_date} {birth_time}", "%Y-%m-%d %H:%M")
            
            # 프로필 정보를 포함한 프롬프트 생성
            profile_context = ""
            if profile_data:
                profile_context = f"""
            === 사용자 현재 상황 ===
            재정상태: {profile_data.get('financial_status', '미입력')}
            직업: {profile_data.get('occupation', '미입력')}
            관심분야: {profile_data.get('interests', '미입력')}
            현재 고민: {profile_data.get('current_challenges', '미입력')}
            목표: {profile_data.get('goals', '미입력')}
            성격특성: {profile_data.get('personality_traits', '미입력')}
            연애상태: {profile_data.get('relationship_status', '미입력')}
            건강관심사: {profile_data.get('health_concerns', '미입력')}
            """
            
            # RAG 컨텍스트 추가 (유사한 사용자 데이터 포함)
            rag_context_section = ""
            if rag_context:
                rag_context_section = f"""
            === 과거 데이터 및 유사한 사용자 데이터 기반 개인화 정보 ===
            {rag_context}
            """
            
            
            # 사주팔자 계산
            saju_result = self.saju_calculator.calculate_saju(birth_date, birth_time)
            saju_analysis = self.saju_calculator.get_detailed_analysis(saju_result)
            
            # 사주 분석을 위한 프롬프트 생성
            prompt = f"""
            다음 정보를 바탕으로 개인화된 사주를 분석해주세요:

            === 기본 정보 ===
            이름: {name}
            생년월일시: {birth_datetime.strftime('%Y년 %m월 %d일 %H시 %M분')}
            추가 메시지: {message}
            {profile_context}
            {rag_context_section}

            === 계산된 사주팔자 ===
            {saju_analysis}

            === 분석 요청사항 ===
            위의 계산된 사주팔자, 현재 상황, 과거 데이터를 종합하여 다음 항목들을 분석해주세요:
            우선 하고싶은 말을 토대로 사주를 요약해서 답변해줘
            1. 계산된 사주팔자 (년주, 월주, 일주, 시주) 상세 해석 살에 대한 분석도 해줘 살의 기준은 밑에 나열했어 존재하는 살에 대해서 어떤살인지 설명해주고 **없는 살에 대해서는 얘기하지말아줘**
            2. 오행 분석 (금, 목, 수, 화, 토) - 계산된 오행 분포 분석
            3. 성격 특성 (사주팔자와 현재 상황, 과거 경험을 연관지어)
            4. 운세 및 조언 (개인화된 조언)
            5. 직업운 (현재 직업과 목표, 과거 경험 고려, 사주팔자 고려, 살 고려)
            6. 연애운 (현재 관계상태와 과거 경험 고려, 사주팔자 고려, 살 고려)
            7. 건강운 (건강관심사와 과거 경험 고려, 사주팔자 고려, 살 고려)
            8. 금전운 (재정상태와 과거 경험 고려, 사주팔자 고려, 살 고려)
            9. 올해 내년 말년의 운세 (현재 고민, 목표, 과거 패턴 고려, 사주팔자 고려, 살 고려)

            === 분석 지침 ===
            - 한국 전통 사주학에 기반하여 분석하되, 현대적이고 실용적인 관점에서 해석
            - 검색에 기반해서 하는 식으로 해줘
            - 사용자의 현재 상황, 고민, 과거 경험을 모두 반영한 개인화된 조언 제공
            - 과거 사주 분석 결과와의 연관성도 고려하여 일관성 있는 조언 제공
            - **유사한 사용자들의 데이터를 참고하여 더 정확한 분석 제공**
            - **같은 생년월일/시간을 가진 사람들의 경험과 패턴을 분석에 활용**
            - **유사한 사용자들의 직업, 재정상태, 고민, 건강관심사 등을 참고하여 조언**
            - 꼭 긍정적인 말만 하지않고 부정적인 말도해줘 그렇다고 부정적인 말만하지는 말고 조화롭게 얘기해줘
            - 각 항목을 구체적이고 실행 가능한 조언으로 작성
            - 과거 데이터와 유사한 사용자 데이터에서 발견된 패턴이나 경향을 활용하여 더 정확한 예측 제공
            === 살 기준 ===
            천을귀인 (天乙貴人)	옥황상제를 뜻하는 최고의 길신. 좋은 운이 열리고 출세하여 부귀공명을 이룸.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲), 무(戊), 경(庚): 축(丑), 미(未)
- 을(乙), 기(己): 자(子), 신(申)
- 병(丙), 정(丁): 해(亥), 유(酉)
- 신(辛): 오(午), 인(寅) 
- 임(壬), 계(癸): 사(巳), 묘(卯)
문창귀인 (文昌貴人)	공부를 잘하며 특히 시험운이 좋음.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 사(巳)
- 을(乙): 오(午)
- 병(丙): 신(申)
- 정(丁): 유(酉)
- 무(戊): 신(申)
- 기(己): 유(酉)
- 경(庚): 해(亥)
- 신(辛): 자(子)
- 임(壬): 인(寅)
- 계(癸): 묘(卯)
복성귀인 (福星貴人)	인복과 먹을 복이 있어 식의 어려움이 없음.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 인(寅)
- 을(乙): 묘(卯)
- 병(丙): 자(子)
- 정(丁): 유(酉)
- 무(戊): 신(申)
- 기(己): 미(未)
- 경(庚): 오(午)
- 신(辛): 사(巳)
- 임(壬): 진(辰)
- 계(癸): 축(丑)
월덕귀인(月德貴人)	달의 덕을 입는다는 의미다. 명예와 품성이 좋고 공직, 관직에 오르는 데 좋은 기운이다. 성품이 온화하고 선량하며 특히 여성에게 길하게 작용한다.	월지(月支)를 기준으로 그에 해당하는 천간(天干)이 사주에 있을 경우 성립한다.
- 자(子): 임(壬)
- 축(丑): 경(庚)
- 인(寅): 병(丙)
- 묘(卯): 갑(甲)
- 진(辰): 임(壬)
- 사(巳): 경(庚)
- 오(午): 병(丙)
- 미(未): 갑(甲)
- 신(申): 임(壬)
- 유(酉): 경(庚)
- 술(戌): 병(丙)
- 해(亥): 갑(甲)
천덕귀인(天德貴人)	하늘의 덕을 입는다는 의미다. 모든 종류의 재난으로부터 자신을 지켜주는 수호천사의 역할을 하며, 다른 사람들보다 적게 피해를 보는 기운이다.		월지(月支)를 기준으로 그에 해당하는 천간(天干)이 사주에 있을 경우 성립한다.
- 자(子): 신(辛)
- 축(丑): 경(庚)
- 인(寅): 정(丁)
- 묘(卯): 신(申)
- 진(辰): 을(乙)
- 사(巳): 신(辛)
- 오(午): 해(亥)
- 미(未): 갑(甲)
- 신(申): 계(癸)
- 유(酉): 인(寅)
- 술(戌): 병(丙)
- 해(亥): 을(乙)
월공(月空) 또는 월공귀인(月空貴人)	'하늘에 뜬 달'을 의미하며, 타인에게 인기를 얻고 주목받는 기운이다. 정치인, 연예인 등 대중 앞에 서는 직업에 유리하다. 하지만 많은 사람의 구설수에 오르내리고, 실력에 비해 성공과 추락이 빠르다는 단점도 있다.	월지(月支)를 기준으로 그에 해당하는 천간(天干)이 사주에 있을 경우 성립한다.
- 자(子): 병(丙)
- 축(丑): 갑(甲)
- 인(寅): 임(壬)
- 묘(卯): 경(庚)
- 진(辰): 병(丙)
- 사(巳): 갑(甲)
- 오(午): 임(壬)
- 미(未): 경(庚)
- 신(申): 병(丙)
- 유(酉): 갑(甲)
- 술(戌): 임(壬)
- 해(亥): 경(庚)
금여 (金與)	배우자운이 좋아 좋은 남편, 아내를 맞이함.	연간(年干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 진(辰)
- 을(乙): 사(巳)
- 병(丙): 미(未)
- 정(丁): 신(申)
- 무(戊): 미(未)
- 기(己): 신(申)
- 경(庚): 술(戌)
- 신(辛): 해(亥)
- 임(壬): 축(丑)
- 계(癸): 인(寅)
건록 (乾祿)	평생 굶어죽을 일 없고 의지가 굳으며 건강함. 관직이나 봉급 생활에 유리.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 인(寅)
- 을(乙): 묘(卯)
- 병(丙): 사(巳)
- 정(丁): 오(午)
- 무(戊): 사(巳)
- 기(己): 오(午)
- 경(庚): 신(申)
- 신(辛): 유(酉)
- 임(壬): 해(亥)
- 계(癸): 자(子)
암록 (暗祿)	남들이 모르는 록(재물, 도움)을 얻음. 위기 시 의외의 도움이 들어옴.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 해(亥)
- 을(乙): 인(寅)
- 병(丙): 신(申)
- 정(丁): 미(未)
- 무(戊): 사(巳)
- 기(己): 오(午)
- 경(庚): 신(申)
- 신(辛): 유(酉)
- 임(壬): 해(亥)
- 계(癸): 인(寅)
삼기 (三奇)	외모가 좋고 포부가 큼.	천간(天干)의 조합에 따라 발동.
- 천상삼기: 갑(甲), 무(戊), 경(庚)이 연간-월간-일간 또는 월간-일간-시간 자리에 순서대로 혹은 거꾸로 배치되어야 함.

- 인간삼기: 을(乙), 병(丙), 정(丁)이 연간-월간-일간 또는 월간-일간-시간 자리에 순서대로 혹은 거꾸로 배치되어야 함.

- 지하삼기: 신(辛), 임(壬), 계(癸)가 연간-월간-일간 또는 월간-일간-시간 자리에 순서대로 혹은 거꾸로 배치되어야 함.
천의성 (天醫星)	병에 대한 저항성이 강하며 의료계, 사회복지사 등 활인업에 좋음.	월지(月支)와 다른 지지(地支)의 조합에 따라 발동.
- 자(子): 해(亥)
- 축(丑): 자(子)
- 인(寅): 축(丑)
- 묘(卯): 인(寅)
- 진(辰): 묘(卯)
- 사(巳): 진(辰)
- 오(午): 사(巳)
- 미(未): 오(午)
- 신(申): 미(未)
- 유(酉): 신(申)
- 술(戌): 유(酉)
- 해(亥): 술(戌)
반안살 (攀鞍煞)	공을 세우거나 높은 지위에 오를 운.	연지(年支)가 속한 삼합(三合)을 기준으로 성립한다.
- 인오술(寅午戌) 삼합: 미(未)
- 사유축(巳酉丑) 삼합: 술(戌)
- 해묘미(亥卯未) 삼합: 진(辰)
- 신자진(申子辰) 삼합: 축(丑)
양인살 (羊刃煞)	강한 기운을 가진 신살. 수술, 교통사고, 사망 등 흉한 작용을 함. 의료계, 법조계 등 생사 관련 직업으로 기운을 상쇄할 수 있음.	일간(日干)과 지지(地支)의 조합에 따라 발동.
- 갑(甲): 묘(卯)
- 병(丙): 오(午)
- 무(戊): 오(午)
- 경(庚): 유(酉)
- 임(壬): 자(子)
도화살 (桃花煞)	색욕을 뜻하는 살. 이성이 끊이지 않으며 유혹에 약함. 긍정적으로는 연예인, 정치인 등 인기 직업에 유리.	일지(日支) 또는 연지(年支)와 지지(地支)의 삼합(三合) 관계에 따라 발동.
- 인오술(寅午戌): 묘(卯) 
- 신자진(申子辰): 유(酉) 
- 사유축(巳酉丑): 오(午) 
- 해묘미(亥卯未): 자(子)
역마살 (驛馬煞)	한 곳에 정착하지 못하고 떠돌게 되는 살. 현대에는 여행, 해외 활동, 갑작스러운 이직 등에 유리하게 작용.	일지(日支) 또는 연지(年支)와 지지(地支)의 삼합(三合) 관계에 따라 발동.
- 인오술(寅午戌): 신(申)
- 신자진(申子辰): 인(寅) 
- 사유축(巳酉丑): 해(亥) 
- 해묘미(亥卯未): 사(巳)
화개살 (華蓋煞)	예술적, 예능적 재능이 있으나 인생에서 인복에 따라 길흉이 크게 달라짐.	일지(日支) 또는 연지(年支)와 지지(地支)의 삼합(三合) 관계에 따라 발동.
- 인오술(寅午戌): 술(戌) 
- 신자진(申子辰): 진(辰) 
- 사유축(巳酉丑): 축(丑) 
- 해묘미(亥卯未):未
공망살 (空亡煞)	모든 노력이 헛되게 되는 살. 길흉의 작용이 무력화됨. 미련살이라고도 함.	일주(日柱)의 지지(地支)와 다른 지지(地支)의 조합에 따라 발동.
- 갑자(甲子)일주: 술(戌), 해(亥)
- 을축(乙丑)일주: 술(戌), 해(亥)
- 병인(丙寅)일주: 신(申), 유(酉)
- 정묘(丁卯)일주: 신(申), 유(酉)
- 무진(戊辰)일주: 오(午), 미(未)
- 기사(己巳)일주: 오(午), 미(未)
- 경오(庚午)일주: 진(辰), 사(巳)
- 신미(辛未)일주: 진(辰), 사(巳)
- 임신(壬申)일주: 인(寅), 묘(卯)
- 계유(癸酉)일주: 인(寅), 묘(卯)
원진살 (元辰殺)	서로 원망하고 화내는 살. 궁합이 좋지 않음.	두 지지(地支)의 조합에 따라 발동.
- 자(子): 미(未)
- 축(丑): 오(午)
- 인(寅): 유(酉)
- 묘(卯): 신(申)
- 진(辰): 해(亥)
- 사(巳): 술(戌)
귀문관살 (鬼門關煞)	정신적 이상, 의처증, 의부증, 변태 기질이 생김. 때로는 비상한 두뇌를 뜻하기도 함.	지지(地支)의 조합에 따라 발동.
- 자(子): 유(酉) 
- 축(丑): 오(午) 
- 인(寅): 미(未) 
- 묘(卯): 신(申) 
- 진(辰): 해(亥)
- 사(巳): 술(戌)
백호살 (白虎殺)	호랑이에게 물려가는 재앙. 교통사고, 질병, 이별 등 부정적 의미를 가지나 특수 재능을 뜻하기도 함.	갑진(甲辰), 을미(乙未), 병술(丙戌), 정축(丁丑), 무진(戊辰), 임술(壬戌), 계축(癸丑) 일주에 해당하는 경우. 일주에 있어야만 대운/세운에서도 성립함.
괴강살 (魁罡煞)	극도로 총명하나 폭력적, 파괴적인 힘을 가짐. 극귀(極貴) 또는 극빈(極貧)으로 나타남.	무술(戊戌), 경진(庚辰), 경술(庚戌), 임진(壬辰) 일주에 해당하는 경우. 일주에 있어야만 성립함.
현침살 (懸針煞)	신경이 예민하고 불면증을 겪기 쉬움. 현대에는 의료, 언론, IT 등 직업과 관련.	갑(甲), 신(辛), 묘(卯), 오(午), 신(申) 이 다섯 글자 중 두 개 이상이 사주에 있으면 성립한다. 해당 글자가 기둥(간지)을 이루면 그 힘이 더욱 강해진다.
홍염살 (紅艶煞)	주색에 관한 살. 자신의 주도로 관계를 이끌어감.	일간(日干)과 지지(地支)의 조합에 따라 성립한다.
- 갑(甲): 오(午)
- 을(乙): 오(午)
- 병(丙): 인(寅)
- 정(丁): 미(未)
- 무(戊): 진(辰)
- 기(己): 진(辰)
- 경(庚): 술(戌)
- 신(辛): 유(酉)
- 임(壬): 자(子)
- 계(癸): 신(申)
급각살 (急脚煞)	다리를 다치거나 골절상을 입는 사고. 물질적/정신적 기반이 파괴되는 것.	다음 두 가지 기준 중 하나가 성립하면 발동한다. 
1. 일간을 기준으로 하는 경우 다음과 같다.
- 갑(甲): 신(申)
- 을(乙): 유(酉)
- 병(丙), 정(丁): 해(亥), 자(子)
- 무(戊), 기(己): 축(丑), 인(寅)
- 경(庚): 진(辰)
- 신(辛): 사(巳)
- 임(壬), 계(癸): 오(午), 미(未)

2. 월지를 기준으로 하는 경우 다음과 같다.
- 인(寅), 묘(卯), 진(辰) 월: 술(戌), 해(亥)
- 사(巳), 오(午), 미(未) 월: 묘(卯), 진(辰)
- 신(申), 유(酉), 술(戌) 월: 인(寅), 축(丑)
- 해(亥), 자(子), 축(丑) 월: 묘(卯), 진(辰)
겁살 (劫殺)	남에게 무언가를 뺏기기 쉬움. 외부의 강력한 힘에 의해 결정되는 의미.	일지(日支)가 속한 삼합(三合)을 기준으로 성립한다.
- 신자진(申子辰) 삼합: 사(巳)
- 인오술(寅午戌) 삼합: 해(亥)
- 해묘미(亥卯未) 삼합: 신(申)
- 사유축(巳酉丑) 삼합: 인(寅)
수옥살 (囚獄煞)	감옥에 갇히거나 자유를 제한 당함.	사주에 진(辰), 술(戌), 축(丑), 미(未) 네 글자 중 하나라도 포함되어 있으면 성립한다.
망신살 (亡身煞)	말 그대로 망신을 당함. 공개적인 망신, 재수 없는 일 등이 발생.	연지(年支) 또는 일지(日支)가 속한 삼합(三合)을 기준으로 해당 망신 지지가 사주, 대운, 또는 세운에 등장할 때 발동한다.
- 신자진(申子辰) 삼합: 사(巳)
- 인오술(寅午戌) 삼합: 해(亥)
- 해묘미(亥卯未) 삼합: 신(申)
- 사유축(巳酉丑) 삼합: 인(寅)
천라지망살(天羅地網殺)	하늘과 땅에 그물이 쳐져 있어 꼼짝하지 못하는 상태. 과거에는 흉살이었으나, 현대에는 종교적 영성이나 내면의 강한 힘으로 재해석되기도 한다. 	지지(地支)에 술(戌)과 해(亥)가 함께 있거나(천라), 진(辰)과 사(巳)가 함께 있는 경우(지망) 성립.
공망살(空亡煞)	텅 비어서 제 기능을 하지 못하는 것을 의미. 해당 육친, 신살의 작용력이 약해지고, '비어 있어서 망한다'는 부정적 의미와 '하늘의 그늘을 받지 못한다'는 의미를 가진다.	일주(日柱)의 천간과 지지의 조합에서 짝을 맺지 못하고 남는 두 지지(地支)가 연지, 월지, 혹은 시지에 있을 때 성립.
원진살(怨嗔煞)	원망하고 미워하는 관계를 뜻한다. 주로 사람과의 관계에서 화를 내고 시기하게 만드는 기운이다.	지지(地支)에 다음과 같은 짝이 함께 있으면 성립한다. 진(辰)과 해(亥), 축(丑)과 오(午), 사(巳)와 술(戌), 묘(卯)와 신(申), 인(寅)과 유(酉), 자(子)와 미(未)의 조합이다.
            """
            
            response = self.model.generate_content(prompt)
            return response.text
            
        except Exception as e:
            print(f"사주 분석 오류: {e}")
            return f"사주 분석 중 오류가 발생했습니다: {str(e)}"
    
